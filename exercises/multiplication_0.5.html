<!DOCTYPE html>
<html data-require="">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>乘法 0.5</title>
    <script src="../khan-exercise.js"></script>
</head>

<body>
    <div class="exercise">
        <div class="vars">
            <var id="A">randFromArray( [ "apple", "banana", "car" ] )</var>
        </div>

        <div class="problems">
            <div>
                <div class="row">
                    <p> 請唸唸看 <var>A</var> !</p>
                    <div id="input_ans" style="display:none;"><var>A</var></div>
                </div>
                <div class="row">
                    <form>
                        <button type="button" class="btn btn-primary" id="start">開始辨識</button>
                        <button type="button" class="btn btn-danger" id="restart">重新開始</button>
                        <button type="button" class="btn btn-success" id="play_text">發聲</button>
                        <span class="label label-success" id="status"></span>
                        <!-- <span class="label label-info" id="os"></span> -->
                    </form>
                </div>
                <div class="row">
                    <form>
                        <div class="form-group">
                            <label for="language">語言</label>
                            <select id="language" name="language" class="form-control">
                                <option value="UK English Female">UK English Female</option>
                                <option value="UK English Male">UK English Male</option>
                                <option value="US English Female" selected>US English Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pitch">音調</label>
                            <select id="pitch" name="pitch" class="form-control">
                                <option value="0">0</option>
                                <option value="0.5">0.5</option>
                                <option value="1.0" selected>1.0</option>
                                <option value="1.5">1.5</option>
                                <option value="2">2</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rate">速度</label>
                            <select id="rate" name="rate" class="form-control">
                                <option value="0.1">0.1</option>
                                <option value="0.3">0.3</option>
                                <option value="0.5">0.5</option>
                                <option value="0.7">0.7</option>
                                <option value="1.0" selected>1.0</option>
                                <option value="1.3">1.3</option>
                                <option value="1.5">1.5</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="solution" data-type="text"><var>A</var></div>
            </div>
        </div>
        <div class="hints">

        </div>
    </div>
    <script>
        var os = getMobileOperatingSystem();
        if (!('webkitSpeechRecognition' in window)) {
            if (os == 'iOS') {
                $('#os').text(os);
                $('#status').text('請使用 Siri 語音輸入法');
                $('#start').hide();
            } else if (os == 'Android') {
                $('#os').text(os);
                $('#status').text('請使用 Chrome 語音輸入法');
                $('#start').hide();
            } else {
                $('#os').text(os);
                $('#status').text('請使用 Chrome');
                $('#start').hide();
            }
        } else {
            $('#os').text(os);
            var recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = true;

            recognizing = false;

            var final_rst = [];
            var inter_rst = [];

            recognition.onstart = function() {
                recognizing = true;
                update_start_btn();
                console.log('recognition start');
                $('#status').text('正在辨識');
            };

            recognition.onend = function() {
                recognizing = false;
                update_start_btn();
                console.log('recognition end');
            };

            recognition.onresult = function(event) {
                console.log('recognition result');
                update_start_btn();
                $('#status').text('辨識完成');
                console.log(event);
                for (var i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        final_rst.push(event.results[i][0].transcript);
                        $("#check-answer-button").removeAttr("disabled")
                        var parsedInput = $.trim(event.results[i][0].transcript.toLowerCase());
                        $('#solutionarea').find('input').val(parsedInput);
                        $('#final_rst_panel').text(event.results[i][0].transcript);
                    } else {
                        inter_rst.push(event.results[i][0].transcript);
                        $('#inter_rst_panel').text($('#inter_rst_panel').text() + ', ' + event.results[i][0].transcript);
                    }
                }

            };

            function reset_recognition() {
                final_rst = [];
                inter_rst = [];
                $('#inter_rst_panel').text('');
                $('#final_rst_panel').text('');
                update_start_btn();
            }


            function update_start_btn() {
                if (recognizing == true) {
                    $('#start').removeClass('btn-primary').addClass('btn-danger');
                    $('#start').text('停止辨識');
                } else {
                    $('#start').removeClass('btn-danger').addClass('btn-primary');
                    $('#start').text('開始辨識');
                }
            }
        }

        function voice_only_input(obj) {
            console.log("voice only init");
            obj.on('keypress', function(event) {
                console.log('keypress');
                event.preventDefault();
                return false;
            });
            obj.on('paste', function(event) {
                console.log('paste');
                event.preventDefault();
                return false;
            });
        }

        function getMobileOperatingSystem() {
            var userAgent = navigator.userAgent || navigator.vendor || window.opera;
            if (userAgent.match(/iPad/i) ||
                userAgent.match(/iPhone/i) ||
                userAgent.match(/iPod/i)) {
                return 'iOS';
            } else if (userAgent.match(/Android/i)) {
                return 'Android';
            } else {
                return userAgent;
            }
        }

        $(document).ready(function() {
            $('#start').click(function() {
                console.log('click');
                if (recognizing == false) {
                    reset_recognition();
                    recognition.start();
                } else {
                    recognition.stop();
                }
            });
            $('#restart').click(function() {
                $('#solutionarea').children("input").val('');
            });
            $('#play_text').click(function() {
                playText();
            });
        });
        var checkVoiceOnlyInput = setInterval(function() {
            if ($('#solutionarea').children("input").length) {
                voice_only_input($('#solutionarea').children("input"));
                $('#solutionarea').children("input").focus();
                console.log("voice only input ok");
                clearInterval(checkVoiceOnlyInput);
                $('#solutionarea').children("input").change(function() {
                    var parsedInput = $.trim($('#solutionarea').children("input").val().toLowerCase());
                    $('#solutionarea').children("input").val(parsedInput);
                    $("#check-answer-button").removeAttr("disabled")
                });
            }
        }, 100);

        function playText() {
            responsiveVoice.speak($("#input_ans").text(), $("#language").val(), {
                pitch: parseFloat($("#pitch").val()),
                rate: parseFloat($("#rate").val()),
                onstart: function() {
                    console.log("read start");
                },
                onend: function() {
                    console.log("read end");
                }
            });
        }

        console.log('speaking js init');
    </script>
</body>

</html>
